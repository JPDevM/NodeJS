This file is a section of [Workflow to create backend with NodeJS](./README.md).

### Edit the methods of the controller from the DataBase.

> You can also see this publication in [Medium]()

![frameworks_logos](./Images_docs/1. b. Edit the methods of the controller from the database/frameworks_logos.png)

##### Create DB with SQL.

> Create a new archive `db.sql` en main folder.

```mysql
CREATE DATABASE pinterest_clone;
USE pinterest_clone;
```

Este es el esquema de la db que vamos a implementar. 

<img src="Images_docs/1. b. Edit the methods of the controller from the database/db_MySQL_idea.png" alt="db_MySQL_idea" style="zoom:33%;" />

##### Create tables Sequelize. --> Migratios rremplaza a create table.

> Tables that do not depend on another table or do not have a Foreign Key (FK) are created first.
>
> The nomenclature of the variables or columns are standardized for [Sequelize](https://sequelize.org/)., E.g. `updated_at` =>` updatedAt`.
>
> In tables with mutual dependency (n:n), the pivot table is created first and then the tables with FK. The pivot table is named by joining the names of the tables.

```mysql
-- Create tables without FK 
CREATE TABLE `users` (
  `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
  `userName` varchar(255) NOT NULL,
  `email` varchar(255) NOT NULL UNIQUE,
  `createdAt` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updatedAt` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `deletedAt` timestamp NULL DEFAULT CURRENT_TIMESTAMP
) DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;
```

```mysql
-- Create tables with FK 
CREATE TABLE `images` (
  `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
  `urlPath` varchar(255) NULL DEFAULT 'no-image.png',
  `description` text NULL DEFAULT NULL,
  `userId` int(10) UNSIGNED DEFAULT NULL,
  `createdAt` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updatedAt` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `deletedAt` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (`userId`) REFERENCES `users` (`id`)
) DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;
```

##### Install Sequelize library and MySQL.

> For create models of the controller.

```shell
$ cd src/ # In src folder
$ npm install sequelize
$ npm install sequelize-cli -g # Globally required 
```

`mysql2` is a Sequelize plugin to work with MySQL.

```shell
$ npm install mysql2
```

##### Create the file structure required by Sequelize.

> This file will create the files and folders for **configurations**, **models**, **seeders**, **migrations**.

Create a file called `.sequelizerc`, with these settings.

```js
const path = require('path');

module.exports = {
	config: path.resolve('./database/config', 'config.js'),
	'models-path': path.resolve('./database/models'),
	'seeders-path': path.resolve('./database/seeders'),
	'migrations-path': path.resolve('./database/migrations'),
};
```

```shell
$ sequelize init # You can see now a database folder in src. 
```

**Configurations:** In `/database/config/config.js` file, specify the user data of the db, the name of the db, and the language of the db (MySQL).

```js
module.exports = {
  "development": {
    "username": "root", // MySQL server user (by default it is root)
    "password": null, // MySQL server password (by default it is empty)
    "database": "db_name", // Name of the DB to connect.
    "host": "127.0.0.1",
    "dialect": "mysql"
  },
  "test": {
    "username": "root",
    "password": null,
    "database": "database_test",
    "host": "127.0.0.1",
    "dialect": "mysql"
  },
  "production": {
    "username": "root",
    "password": null,
    "database": "database_production",
    "host": "127.0.0.1",
    "dialect": "mysql"
  }
}
```

**Models:** is the code representation of a table, e.g. `image`.

> A model is an abstraction that represents a table in your database.
>
> The model tells Sequelize several things about the entity it represents, such as the name of the table in the database and which columns it has  (and their data types).

In `/database/models/table_name.js` file, specify model columns.

```js
module.exports = (sequelize, dataTypes) => {
  
  // Define the structure of the model
  const image = sequelize.define(
    // 1. Model name.
    'image',
    
    // 2. attributes of the database to access
    {
      urlPath: dataTypes.STRING(),
      description: dataTypes.STRING(),
      userId: dataTypes.NUMBER,
    }
  )

  // Association with the user table. To see your values.
  image.associate = (models) => {
    // The BelongsTo association. Source: https://sequelize.org/master/manual/assocs.html
    // The Image.belongsTo(B) association means that a One-To-One relationship exists between A and B, with the foreign key being defined in the source model (A).
    image.belongsTo(models.user, {
      as: 'user',
      foreignKey: 'userId'
    })
  }

  return image;
}
```

Import model into controller imagesController.js.

```js
// import model into controller.
const { image } = require('../database/models');

const controller = {
	browse: (req, res) => {
		image.findAll()
			.then(images => {
				return res.json(images);
			})
	},
  read: (req, res) => {
		return res.send('The Subscriptions See page works ok');
	},

	edit: (req, res) => {
		return res.send('The Subscriptions Edit One page works ok');
	},

	add: (req, res) => {
		let dataToSave = {
			// Use variable names from the db.
       urlPath: req.body.urlPath, // Constancy in the db: the last argument of the body (urlPath) is the name = "urlPath" tag of the front form. 
			description: req.body.description,
			userId: 1,
		};

		image.create(dataToSave) 
    	// Success message. 
			.then(data => {
				return res.send({
					status: 200,
					message: 'done',
					data: data
				});
			})
			// Error message. Optional; when not saved in the db. 
			.catch(error => {
				return res.status(504).send({
					status: 504,
					message: 'Imposible guardar en la DB.'
				})
			})
	},

	delete: (req, res) => {
		return res.send('The Subscriptions Delete page works ok');
	},
};

module.exports = controller;
```

# Agregar los Seeders

Empezar por lo que no tienen FK, luego los que si tienen FK

 ### Agregar en el package.json que se haga la migrations y los seeders





models/image.js

```js
module.exports = (sequelize, dataTypes) => {
	// Definir la estructura del modelo
	const image = sequelize.define(
		// 1. nombre del modelo - cómo vamos a reconocer a este modelo por fuera de este archivo
		'image',
		// 2. columnas a las que queremos tener acceso
		{
			urlPath: dataTypes.STRING(),
			description: dataTypes.STRING(),
			userId: dataTypes.NUMBER,
		}
	)

	return image;
}
```



Submit del formulario.

```js

```



```js
// Proceso para almacenar imágenes
const saveForm = document.querySelector('#saveForm');
const imageSaved = document.querySelector('.image-saved');

saveForm.addEventListener('submit', e => {
	e.preventDefault();
		
	const imageData = {
		urlPath: saveForm.urlPath.value,
		description: saveForm.description.value,
	}
	
	fetch('http://localhost:3000/images', { 
		method: 'POST',
		body: JSON.stringify(imageData),
		headers: {
			'Content-Type': 'application/json'
		}
	})
		.then(response => response.json())
		.then(data => {
			saveForm.reset(); // JS que borra los values del form.
			document.querySelector('.grid').innerHTML = '';
			getImages(); // JS que carga las imágenes
		})
		.catch(error => {
			console.log(error);
		})
})
```



```js

```



In the router file. e.g.:<u>subscriptionsControllers.js</u>

> Idem in the other controllers entities. e.i.: staticControllers.js, promotionsControllers.js, usersControllers.js

###### BROWSE

> Show all results.

```js
browse: (request, response) => {
  /* Database metod */
},
```

> Deliver a message of success or error. (Falta agregar el mensaje de error)

```js
browse: (request, response) => {
  /* Database metod */
},
```

> Paginate the API. Create a function.
>
> Params: page, max_per_page.
>
> Model: http://DB_HOST/DB_PORT/entity?page=2&max_per_page=10
>
> E.g.: http://localhost:5000/subscriptions?page=2&max_per_page=10

```js
	browse: (request, response) => {
		/* Database metod */
	},

```

###### UPDATE

```js
update: (request, response) => {
  /* Database metod */
},
```

###### CREATE

```js
create: (request, response) => {
  /* Database metod */
  },
```

###### DELETE

```js
delete: (request, response) => {
  /* Database metod */
},
```

###### READ

```js
read: (request, response) => {
 /* Database metod */
},
```

###### (Añadir el método SEARCH) (no lo llamo desde el router o nada... arreglar)

```js
search: (request, response) => {
 /* Database metod */
};
```

###### SEARCH

> Hacer la paginación de cantidad de resultados en el request de la API. Ejemplo (enviarte 20 registros).

```js
 // editar esto
};
```



# Trabajando con sequelize

Sequelize es un ORM para trabajar con bases de datos dentro de los entornos de express. [Aquí se encuentra la documentación oficial](https://sequelize.org/)

1. Instalar sequelize en nuestro proyecto

```
npm install sequelize
```

2. Instalar *mysql2*, es un plugin para trabajar con MySQL dentro Sequelize.

```
npm install mysql2
```

Despues de instaladas esta librerías, vamos a necesitar comenzar a configurar la estructura de la base de datos con la que vamos a trabajar.

Para poder generar toda la estructura de archivos que necesita Sequelize para trabajar, necesitamos de un archivo llamado `.sequelizerc`. El archivo deberá tener esta estructura: 

```
const path = require('path');

module.exports = {
	config: path.resolve('./database/config', 'config.js'),
	'models-path': path.resolve('./database/models'),
	'seeders-path': path.resolve('./database/seeders'),
	'migrations-path': path.resolve('./database/migrations'),
};
```

3. Una vez tengamos el archivo, ahora desde la terminal vamos a ejecutar un comando, para que se generen esta estructura de carpetas de manera automática.

```
sequelize init
```

> El comando `sequelize` es un comando de consola que para tenerlo disponible necesitamos previamente instalarlo de manera GLOBAL. ¿Cómo se instala este comando? `npm i sequelize-cli -g`. 

4. Con la estructura de archivos listos, vamos a `/database/config/config.js` y le vamos a hacer ciertas modificaciones:

```js
module.exports = { // sumar el module.exports =
  "development": {
    "username": "root", // el usuario de MySQL server (por defecto es root)
    "password": null, // la contraseña de MySQL server (por defecto es vacía)
    "database": "movies_db_2020", // acá va el nombre de la DB con la que nos vamos a conectar
    "host": "127.0.0.1",
    "dialect": "mysql"
  },
  "test": {
    "username": "root",
    "password": null,
    "database": "database_test",
    "host": "127.0.0.1",
    "dialect": "mysql"
  },
  "production": {
    "username": "root",
    "password": null,
    "database": "database_production",
    "host": "127.0.0.1",
    "dialect": "mysql"
  }
}
```

5. **Creando un modelo**: como nos interesa tener un acceso a la base de datos de una manera más performante, lo recomendable será trabajar con modelos, para poder usar los métodos de consulta en vez de hacer consultas cruda. Para crear un modelo, vamos a crear un archivo dentro de la carpeta `/models`. Este archivo tendrá como nombre, el mismo nombre de la tabla de la DB a la que queremos tener acceso.

> *Importante:* un modelo es la representación en código de una tabla. Dentro del modelo, nosotros definimos qué columnas queremos traer.

La estructura básica de un modelo es así:

```js
module.exports = (sequelize, dataTypes) => {
	// Definir la estructura del modelo
	const movie = sequelize.define(
		// 1. nombre del modelo - cómo vamos a reconocer a este modelo por fuera de este archivo
		'peliculas',
		// 2. columnas a las que queremos tener acceso
		{
			title: dataTypes.STRING()
		},
		// 3. Configuraciones adicionales
		{
			tableName: 'movies', // nombre real de la tabla
			timestamps: false, // para definir si queremos o no las columnas createdAt y updatedAt
		}
	)

	return movie;
}
```

6. **Configuraciones adicionales para TODOS los modelos**: si es necesario agregar una particularidad a TODOS los modelos por igual, podemos hacer eso pero ahora dentro del archivo `./config/config.js`, así:

```js
module.exports = {
  "development": {
    "username": "root",
    "password": null,
    "database": "database_name",
    "host": "127.0.0.1",
    "dialect": "mysql",
    // Configuraciones adicionales para TODOS los modelos
    "define": {
      underscored: true // esto aplica para TODOS los modelos
    }
  },
  // ...
}
```

7. **Métodos de consulta**: los métodos disponibles para TODOS los modelos son: 

* `findAll`: busca todos los registros en la tabla para esta entidad
* `findByPk`: busca un registro a partir de su Primary Key (id)
* `findOne`: busca un registro dependiendo de un *where* y un *limit*
* `create`: inserta un registro nuevo en la tabla
* `update`
* `destroy`: elimina un registro de la tabla

8. **Soft deletes**: un mecanismo que nos permite evitar tener que borrar algo de la DB. Un soft delete es una marca de tiempo en una columna de la tabla que define que ese registro fue "eliminado". Para que el soft delete pueda ser usado de manera correcta. Tenemos que implementar esto en el archivo `config.js`:

```js
module.exports = {
  "development": {
    "username": "root",
    "password": null,
    "database": "database_name",
    "host": "127.0.0.1",
    "dialect": "mysql",
    // Configuraciones adicionales para TODOS los modelos
    "define": {
      underscored: true // esto aplica para TODOS los modelos
      paranoid: true // esto aplica para TODOS los modelos
    }
  },
  // ...
}
```

9. **Relaciones**

* Para relacionar dos modelos entre sí, necesitamos los dos modelos dentro de nuestra carpeta `models`
* Dentro del modelo que queremos relacionar vamos a hacer lo siguiente:

```js
movie.associate = function (models) {
    // Relación de pertenece a (N:1):
		movie.belongsTo(models.genre, { 
			as: 'genre', // alias de la relacion
			foreignKey: 'genre_id'
		 });
	}
```

```js
genre.associate = function (models) {
		// Relación de tiene muchos (1:N):
		genre.hasMany(models.movie, {
			as: 'movies', // alias de la relacion
			foreignKey: 'genre_id' // la columna que almacena la referencia a la otra tabla
		});
	}
```

* El método de la relación, recibe dos argumentos:
  - Nombre del modelo -> `models.genre`
  - Configuración -> `{ as: 'aliasDeLaRelación', foreignKey: 'columna_con_id' }`
* En la consulta para poder traer la relación tenemos que hacer esto:

```js
movie.findAll({
  include: ['genre']
})
```

## Todo

- [x] Configuraciones adicionales para todos los modelos
- [x] Métodos de consulta: `findAll`, `findByPk`, `findOne`, `create`, `update`, `delete`
- [x] Operadores de sequelize: `where`, `order`, `limit`, `offset`
- [x] Soft deletes
- [ ] Relaciones entre modelos